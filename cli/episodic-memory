#!/bin/bash
set -e
set -o pipefail

# Resolve the real directory even if this script is symlinked
SOURCE="${BASH_SOURCE[0]}"
while [ -h "$SOURCE" ]; do
  DIR="$(cd -P "$(dirname "$SOURCE")" && pwd)"
  SOURCE="$(readlink "$SOURCE")"
  [[ $SOURCE != /* ]] && SOURCE="$DIR/$SOURCE"
done
SCRIPT_DIR="$(cd -P "$(dirname "$SOURCE")" && pwd)"

# Validate SCRIPT_DIR was resolved successfully
if [ -z "$SCRIPT_DIR" ]; then
  echo "Error: Failed to determine script directory" >&2
  exit 1
fi

# Main CLI entry point with subcommands
COMMAND="$1"
shift

case "$COMMAND" in
  index)
    # Route to index-conversations script with remaining args
    "$SCRIPT_DIR/index-conversations" "$@"
    ;;

  search)
    # Route to search implementation
    (cd "$SCRIPT_DIR/.." && npx tsx "./src/search-cli.ts" "$@")
    exit $?
    ;;

  show)
    # Route to show implementation
    (cd "$SCRIPT_DIR/.." && npx tsx "./src/show-cli.ts" "$@")
    exit $?
    ;;

  stats)
    # Route to stats implementation
    (cd "$SCRIPT_DIR/.." && npx tsx "./src/stats-cli.ts" "$@")
    exit $?
    ;;

  sync)
    # Route to sync implementation
    (cd "$SCRIPT_DIR/.." && npx tsx "./src/sync-cli.ts" "$@")
    exit $?
    ;;

  --help|-h|"")
    cat <<'EOF'
episodic-memory - Manage and search Claude Code conversations

USAGE:
  episodic-memory <command> [options]

COMMANDS:
  sync        Sync conversations from ~/.claude/projects and index them
  index       Index conversations for search
  search      Search indexed conversations
  show        Display a conversation in readable format
  stats       Show index statistics

Run 'episodic-memory <command> --help' for command-specific help.

EXAMPLES:
  # Index all conversations
  episodic-memory index --cleanup

  # Search for something
  episodic-memory search "React Router auth"

  # Display a conversation
  episodic-memory show path/to/conversation.jsonl

  # Generate HTML output
  episodic-memory show --format html conversation.jsonl > output.html
EOF
    ;;

  *)
    echo "Unknown command: $COMMAND"
    echo "Try: episodic-memory --help"
    exit 1
    ;;
esac
